{% extends 'base.html' %} 

{% block content %}
<div class="cart-container" id="cart-container">
    <div class="cart-header">
        <h1>Shopping Cart</h1>
        <p id="item-count-text">You have {{ items|length }} item(s) in your cart</p>
    </div>

    {% if items %}
        <div class="cart-grid" id="full-cart">
            <div class="cart-items" id="cart-items-list">
                {% for item in items %}
                    <div class="cart-item" data-product-id="{{ item.product.id }}" id="cart-item-{{ item.product.id }}">
                        <div class="cart-item-img">
                            {% if item.product.image %}
                                <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
                            {% else %}
                                <i class="fas fa-image fa-2x" style="color: var(--border);"></i>
                            {% endif %}
                        </div>
                        
                        <div class="cart-item-info">
                            <h3>{{ item.product.name }}</h3>
                            <p>Rs. {{ item.product.price }} / unit</p>
                            
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div class="qty-controls">
                                    <button class="qty-btn ajax-cart-btn" data-action="decrease" data-url="{% url 'decrease_cart' item.product.id %}">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <span class="item-quantity" style="font-weight: 600; font-size: 0.9rem; min-width: 20px; text-align: center;">{{ item.quantity }}</span>
                                    <button class="qty-btn ajax-cart-btn" data-action="increase" data-url="{% url 'add_to_cart' item.product.id %}" {% if item.quantity >= item.product.stock %}disabled style="opacity: 0.3;"{% endif %}>
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                
                                <button class="item-remove ajax-cart-btn" data-action="remove" data-url="{% url 'remove_from_cart' item.product.id %}">
                                    <i class="fas fa-trash-alt"></i> Remove
                                </button>
                            </div>
                        </div>
                        
                        <div class="item-pricing">
                            <div class="item-price-subtotal">Rs. {{ item.subtotal }}</div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <div class="cart-summary">
                <h3>Order Summary</h3>
                <div class="summary-details">
                    <div class="summary-row">
                        <span style="color: var(--text-muted);">Subtotal</span>
                        <span class="cart-total-display" style="font-weight: 600;">Rs. {{ total_amount }}</span>
                    </div>
                    <div class="summary-row">
                        <span style="color: var(--text-muted);">Shipping</span>
                        <span style="color: var(--secondary); font-weight: 600;">FREE</span>
                    </div>
                    <div class="summary-total">
                        <span>Total</span>
                        <span class="cart-total-display">Rs. {{ total_amount }}</span>
                    </div>
                </div>
                
                <a href="{% url 'checkout' %}" class="btn-primary" style="display: flex; width: 100%; margin-top: 2rem; padding: 1rem; justify-content: center;">
                    Checkout <i class="fas fa-arrow-right" style="margin-left: 0.5rem;"></i>
                </a>
            </div>
        </div>
    {% endif %}

    <div class="empty-cart-state {% if items %}hidden-element{% endif %}" id="empty-cart-msg" style="text-align: center; padding: 6rem 0;">
        <i class="fas fa-shopping-basket fa-4x" style="color: var(--border); margin-bottom: 2rem;"></i>
        <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem;">Your cart is empty</h2>
        <p style="color: var(--text-muted); margin-bottom: 2rem;">Looks like you haven't added anything to your cart yet.</p>
        <a href="{% url 'home' %}" class="btn-primary">
            Start Shopping
        </a>
    </div>
</div>

<style>
    .hidden-element { display: none !important; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.ajax-cart-btn');
        if (!btn) return;
        
        e.preventDefault();
        const url = btn.dataset.url;
        const action = btn.dataset.action;
        const productId = btn.closest('.cart-item')?.dataset.productId;

        btn.disabled = true;

        fetch(url, {
            headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': '{{ csrf_token }}' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success || action === 'decrease' || action === 'remove') {
                updateCartUI(data, productId, action);
            }
            btn.disabled = false;
        })
        .catch(error => {
            console.error('Error:', error);
            btn.disabled = false;
        });
    });

    function updateCartUI(data, productId, action) {
        const cart = data.cart;
        document.querySelectorAll('.cart-total-display').forEach(el => {
            el.textContent = 'Rs. ' + cart.total_amount.toFixed(1);
        });
        document.getElementById('item-count-text').textContent = `You have ${cart.total_items} item(s) in your cart`;

        const itemData = data.item;
        const itemRow = document.getElementById(`cart-item-${productId}`);

        if (!itemData && itemRow) {
            itemRow.style.opacity = '0';
            setTimeout(() => {
                itemRow.remove();
                if (cart.total_items === 0) showEmptyState();
            }, 300);
        } else if (itemData && itemRow) {
            itemRow.querySelector('.item-quantity').textContent = itemData.quantity;
            itemRow.querySelector('.item-price-subtotal').textContent = 'Rs. ' + itemData.subtotal.toFixed(1);
            
            const incBtn = itemRow.querySelector('[data-action="increase"]');
            if (itemData.quantity >= itemData.stock) {
                incBtn.disabled = true;
                incBtn.style.opacity = '0.3';
            } else {
                incBtn.disabled = false;
                incBtn.style.opacity = '1';
            }
        }
        if (cart.total_items === 0) showEmptyState();
    }

    function showEmptyState() {
        const fullCart = document.getElementById('full-cart');
        if (fullCart) fullCart.classList.add('hidden-element');
        const emptyMsg = document.getElementById('empty-cart-msg');
        if (emptyMsg) emptyMsg.classList.remove('hidden-element');
    }
});
</script>
{% endblock %}
